---
title: "ManyClasses 1 Simulated Analysis"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(runjags)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggridges)
library(ggstance)
library(stringr)
library(tibble)
library(forcats)
library(purrr)
library(tidybayes)
```

# Generating Fake Data

To simulate the analysis, we generate data that has the same structure as the eventual ManyClasses 1 data. These are the parameters of that data generating process.

```{r}
n.classes <- 50
```

Generate a data frame of classes with random values for each factor.

```{r}
classes <- data.frame(
  class.id=1:n.classes,
  incentive=factor(sample(c("Incentive", "No Incentive"), n.classes, replace=T), levels=c("No Incentive", "Incentive")),
  discipline=factor(sample(c("STEM", "Non-STEM"), n.classes, replace=T), levels=c("Non-STEM", "STEM")),
  format=factor(sample(c("Classroom", "Online", "Hybrid"), n.classes, replace=T), levels=c("Classroom", "Hybrid", "Online")),
  class.size=rbinom(n.classes, 150, 0.5),
  proportion.lecture=rbeta(n.classes, 0.8, 0.8),
  n.assignments=2+rbinom(n.classes, 10, 0.1),
  class.level=factor(sample(c("Intro","Intermediate","Advanced"), n.classes, replace=T), levels=c("Intro", "Intermediate", "Advanced")),
  n.exams=2+sample(c(0,2),n.classes, prob = c(0.8, 0.2), replace=T),
  admission.rate=rbeta(n.classes,3,2)
)
```


Then we generate students that come from each class, create exams, assign random scores to the exams, and normalize the data. To norm the data we z-score each exam separately, and then find the average difference in z-scores for delayed and immediate feedback.

```{r}
student.data <- NA
for(c in 1:n.classes){
  class.size <- classes$class.size[c]
  student.id <- 1:class.size
  exam <- 1:(classes$n.exams[c])
  one.class <- expand.grid(student.id=student.id, exam=exam) %>% 
    mutate(immediate.feedback = if_else(student.id <= class.size/2, exam %% 2 == 1, exam %% 2 == 0)) %>% 
    mutate(feedback = if_else(immediate.feedback, "Immediate", "Delayed")) %>% 
    select(-immediate.feedback) %>%
    mutate(exam.score = rnorm(n(),0,1)) %>%
    group_by(exam) %>%
    mutate(m = mean(exam.score), sd = sd(exam.score), exam.score.normed = (exam.score - mean(exam.score)) / sd(exam.score)) %>%
    ungroup() %>%
    group_by(student.id, feedback) %>%
    summarize(average.z = mean(exam.score.normed)) %>%
    spread(feedback, average.z) %>%
    mutate(delta.z = Immediate - Delayed) %>%
    mutate(class.id = c)
  if(c > 1){
    student.data <- rbind(student.data, one.class)
  } else {
    student.data <- one.class
  }
}
```

Generating moderator variables for students

```{r}
student.data <- student.data %>% mutate(
  #access.assignment = sample(c("No", "Yes"), n(), replace=T, prob=c(0.1, 0.9)),
  cumulative.assignment.time = rgamma(n(), 10),
  cumulative.feedback.time = rgamma(n(),10),
  cumulative.canvas.grade = rnorm(n(), 0, 1), # normalized
  submission.days.early = runif(n(),0,5),
  feedback.delay = runif(n(),1,10)
)
```

Join the class moderators to the student data

```{r}
student.class.data <- student.data %>%
  left_join(classes, by="class.id")
```

Add effects to the data

```{r}
# overall effect of feedback
student.class.data <- student.class.data %>%
  mutate(delta.z = delta.z + rnorm(n(),0.2,1))

# classroom-level discrete moderator
student.class.data <- student.class.data %>%
  mutate(delta.z = case_when(
    class.level=="Intro" ~ delta.z + rnorm(n(), -0.1, 1),
    class.level=="Intermediate" ~ delta.z + rnorm(n(), 0, 1),
    class.level=="Advanced" ~ delta.z + rnorm(n(), 0.1, 1)
  ))

# classroom-level continuous moderator
student.class.data <- student.class.data %>%
  mutate(delta.z = delta.z + (admission.rate - 0.5) + rnorm(n(), 0, 1))

# student-level continuous moderator
student.class.data <- student.class.data %>%
  mutate(delta.z = delta.z + 0.25 * cumulative.canvas.grade + rnorm(n(), 0, 0.5))
```


# Preparing Data for Model

The data needs to be reformatted for the JAGS model.

```{r}
# summaries for JAGS
delta.z <- student.class.data$delta.z
n.students <- nrow(student.class.data)
class.index <- student.class.data$class.id
class.condition <- as.numeric(classes$incentive)
n.conditions <- 2

# packaging data for JAGS
jags.data <- list(
  delta.z=delta.z,
  n.students=n.students,
  class.index=class.index,
  class.condition=class.condition,
  n.conditions=n.conditions,
  n.classes=n.classes
)
```

# Model 1: Overall Effect of Feedback and Incentives

```{r}
# set some runjags options
runjags.options(force.summary=TRUE, silent.jags=TRUE, silent.runjags=TRUE)
```

## Running the Model

```{r message=FALSE, warning=FALSE}
model.1.result <- run.jags(
  model='basic-model-jags.txt', 
  data=jags.data,
  n.chains = 3,
  sample = 1000,
  burnin = 1000,
  monitor = c('mu.class','sigma.class', 'mu.condition.effect', 'sigma.condition.effect', 'sigma.mode', 'sigma.sd', 'mu.condition.diff', 'mu.condition.average')
)
```

## Class-level effect of feedback and incentive

```{r fig.height=7, fig.width=7}
tidy.model.1.summary <- model.1.result %>%
  gather_draws(mu.class[class.id], mu.condition.effect[incentive], mu.condition.average) %>%
  median_hdi(.width = c(0.5,0.95)) %>%
  left_join(classes, by=c("class.id")) %>%
  mutate(incentive.y = as.character(incentive.y)) %>%
  mutate(incentive = case_when(
    .variable == "mu.condition.average" ~ "z",
    incentive.x == 1 ~ "No Incentive",
    incentive.x == 2 ~ "Incentive",
    is.na(incentive.x) ~ incentive.y
  )) %>%
  select(-incentive.x, -incentive.y) %>%
  mutate(y.label = case_when(
    .variable == 'mu.condition.average' ~ "Overall Effect",
    is.na(class.id) ~ incentive,
    !is.na(class.id) ~ as.character(class.id)
  )) %>%
  ungroup() %>%
  mutate(.variable = factor(.variable, levels=c('mu.class', 'mu.condition.effect', 'mu.condition.average'))) %>%
  mutate(y.label = factor(y.label)) %>%
  mutate(y.label = fct_reorder(y.label, .value))
  
ggplot(tidy.model.1.summary, aes(x=.value, y=y.label, xmin=.lower, xmax=.upper, color=incentive))+
  geom_vline(xintercept=0, linetype='dashed') +
  geom_pointintervalh(shape=15) +
  labs(y="Class ID", x="Relative Benefit of Immediate Feedback")+
  facet_grid(.variable~., scales = 'free', space='free')+
  scale_color_manual(name="Incentive Condition", breaks=c("No Incentive", "Incentive"), labels=c("No Incentive", "Incentive", NULL), values=c("#377eb8", "#e41a1c", "Black"))+
  theme_minimal()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```

Summary stats on difference between Incentive and No Incentive estimated by model.

```{r}
model.1.result %>% 
  gather_draws(mu.condition.diff, mu.condition.average) %>%
  median_hdi(.width = c(0.95))
```

Quick plot of Means and SEs without model estimation, to illustrate degree of shrinkage.

```{r}
student.class.data %>% 
  group_by(class.id) %>% 
  summarise(m = mean(delta.z), se=sd(delta.z)/sqrt(n())) %>%
  left_join(classes, by="class.id") %>%
  mutate(class.id = factor(class.id)) %>%
  mutate(class.id = fct_reorder(class.id, m)) %>%
  ggplot(aes(x=m, xmin=m-se, xmax = m+se, y=class.id, color=incentive)) +
  geom_vline(xintercept=0, linetype='dashed') +
  geom_errorbarh()+
  scale_color_brewer(type="qual", palette = "Set1")+
  theme_minimal()
```

# Heterogeneity Analysis

```{r}
model.1.h.tidy <- model.1.result %>% gather_draws(sigma.condition.effect[incentive])

model.1.h.tidy %>% median_hdi(.width = c(0.95))
```

# Moderator Analysis

## Class Level

Create a function to pick the correct model and pass in the correct data values.

```{r}
estimate.class.moderator.effect <- function(moderator.name, summarize=TRUE){
  
  print(moderator.name)
  
  if(!moderator.name %in% colnames(classes)) {
    stop(paste0("Moderator '", moderator.name, "' does not appear in classes data frame"))
  }
  
  # packaging data for JAGS
  jags.data.moderator <- list(
    delta.z=delta.z,
    n.students=n.students,
    class.index=class.index,
    class.condition=class.condition,
    n.conditions=n.conditions,
    n.classes=n.classes,
    moderator.level = as.numeric(classes[[moderator.name]]),
    no.incentive.classes = which(class.condition==1),
    incentive.classes = which(class.condition==2)
  )
  
  if(is.numeric(classes[[moderator.name]])){
    model <- 'cont-moderator-model-jags.txt'
  } else {
    model <- 'disc-moderator-model-jags.txt'
    jags.data.moderator$n.moderator.levels = length(levels(classes[[moderator.name]]))
  }
  
  model.moderator.result <- run.jags(
    model=model, 
    data=jags.data.moderator,
    n.chains = 3,
    sample = 3000,
    burnin = 1000,
    monitor = c('mu.class','sigma.class', 'mu.condition.effect', 'sigma.condition.effect', 'sigma.mode', 'sigma.sd', 'moderator.effect', 'r.sq')
  )
  
  if(summarize){
    df <- model.moderator.result %>%
      gather_draws(r.sq[incentive], sigma.condition.effect[incentive]) %>%
      median_hdci(.value, .width=c(0.5,0.95)) %>%
      mutate(moderator = moderator.name)
    
    return(df)
  } else {
    return(model.moderator.result)
  }
}
```

Iterate through moderators and run the models.

```{r message=FALSE, warning=FALSE}
class.level.moderators <- colnames(classes)[3:length(colnames(classes))]

class.moderator.estimates <- NA
for(m in class.level.moderators){
  md <- estimate.class.moderator.effect(m)
  if(is.na(class.moderator.estimates)){
    class.moderator.estimates <- md
  } else {
    class.moderator.estimates <- rbind(class.moderator.estimates, md)
  }
}
```

Plot class-level moderators

```{r}
ggplot(class.moderator.estimates %>% filter(.variable=="r.sq"), aes(x=.value, xmin=.lower, xmax=.upper, y=moderator, color=factor(incentive)))+
  geom_pointintervalh(shape=15, position = position_dodgev(height=0.3)) +
  labs(y="Moderator", x="Bayes R2")+
  theme_minimal()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```

```{r}
ggplot(class.moderator.estimates %>% filter(.variable=="sigma.condition.effect"), aes(x=.value, xmin=.lower, xmax=.upper, y=moderator, color=factor(incentive)))+
  geom_pointintervalh(shape=15, position = ggstance::position_dodgev(height = 0.4)) +
  labs(y="Moderator", x="SD of Classroom-level estimates around moderator")+
  theme_minimal()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```

## Student Level

```{r}
estimate.student.moderator.effect <- function(moderator.name, summarize=TRUE){
  
  print(moderator.name)
  
  if(!moderator.name %in% colnames(student.data)) {
    stop(paste0("Moderator '", moderator.name, "' does not appear in student.data data frame"))
  }
  
  # packaging data for JAGS
  jags.data.moderator <- list(
    delta.z=delta.z,
    n.students=n.students,
    class.index=class.index,
    class.condition=class.condition,
    n.conditions=n.conditions,
    n.classes=n.classes,
    moderator.level = as.numeric(student.data[[moderator.name]]),
    no.incentive.classes = which(class.condition==1),
    incentive.classes = which(class.condition==2)
  )
  
  if(is.numeric(student.data[[moderator.name]])){
    model <- 'cont-student-moderator-model-jags.txt'
  } else {
    model <- 'disc-student-moderator-model-jags.txt'
    jags.data.moderator$n.moderator.levels = length(levels(classes[[moderator.name]]))
  }
  
  model.moderator.result <- run.jags(
    model=model, 
    data=jags.data.moderator,
    n.chains = 3,
    sample = 3000,
    burnin = 1000,
    monitor = c('mu.class','sigma.class', 'mu.condition.effect', 'sigma.condition.effect', 'sigma.mode', 'sigma.sd', 'moderator.effect', 'r.sq')
  )
  
  if(summarize){
    df <- model.moderator.result %>%
      gather_draws(r.sq[incentive], sigma.condition.effect[incentive]) %>%
      median_hdci(.value, .width=c(0.5,0.95)) %>%
      mutate(moderator = moderator.name)
    
    return(df)
  } else {
    return(model.moderator.result)
  }
}
```

```{r message=FALSE, warning=FALSE}
student.level.moderators <- colnames(student.data)[6:length(colnames(student.data))]

student.moderator.estimates <- NA
for(m in student.level.moderators){
  md <- estimate.student.moderator.effect(m)
  if(is.na(student.moderator.estimates)){
    student.moderator.estimates <- md
  } else {
    student.moderator.estimates <- rbind(student.moderator.estimates, md)
  }
}
```

Plot student-level moderators

```{r}
ggplot(student.moderator.estimates %>% filter(.variable=="r.sq"), aes(x=.value, xmin=.lower, xmax=.upper, y=moderator, color=factor(incentive)))+
  geom_pointintervalh(shape=15, position = position_dodgev(height=0.3)) +
  labs(y="Moderator", x="Bayes R2")+
  theme_minimal()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```

# Plotting individual moderators

## Classroom-level



```{r}
moderator.name <- 'admission.rate'

moderator.model.results <- estimate.class.moderator.effect(moderator.name, summarize=FALSE)

#df <- model.moderator.result %>% spread_draws(mu.class[class.id], mu.condition.effect[incentive], sigma.condition.effect[incentive], moderator.effect[incentive]) 

# todo: convert standardized regression coefficient back to normal scale.
# need to convert intercept because it is intercept when Z = 0, not un.z = 0

model.class.estimates <- moderator.model.results %>%
  gather_draws(mu.class[class.id]) %>%
  median_hdi(.width = c(0.5, 0.95)) %>%
  left_join(classes, by="class.id")

model.moderator.estimates <- moderator.model.results %>%
  spread_draws(mu.condition.effect[incentive], moderator.effect[incentive]) %>%
  mutate(moderator.effect.un.z = moderator.effect / sd(classes[[moderator.name]])) %>%
  mutate(mu.condition.effect.un.z = mu.condition.effect - moderator.effect * mean(classes[[moderator.name]])/sd(classes[[moderator.name]])) %>%
  ungroup() %>%
  mutate(incentive = factor(incentive, labels=c("No Incentive", "Incentive"))) %>%
  group_by(incentive) %>%
  sample_n(20)
  
ggplot(model.class.estimates, aes(x=admission.rate, y=.value, ymin=.lower, ymax=.upper, color=incentive)) +
  geom_pointinterval() +
  geom_abline(data=model.moderator.estimates, aes(intercept = mu.condition.effect.un.z, slope=moderator.effect.un.z, color=factor(incentive)), alpha=0.2) +
  labs(x="University Admission Rate", y="Model estimate of classroom average")+
  scale_color_brewer(type="qual", palette = "Set1", name="Incentive Condition")+
  theme_bw()
```

## Student-level

```{r}
student.moderator.name <- 'cumulative.canvas.grade'

student.moderator.model.results <- estimate.student.moderator.effect(student.moderator.name, summarize=FALSE)

model.moderator.estimates <- student.moderator.model.results %>%
  spread_draws(mu.condition.effect[incentive], moderator.effect[incentive]) %>%
  mutate(moderator.effect.un.z = moderator.effect / sd(classes[[moderator.name]])) %>%
  mutate(mu.condition.effect.un.z = mu.condition.effect - moderator.effect * mean(classes[[moderator.name]])/sd(classes[[moderator.name]])) %>%
  ungroup() %>%
  mutate(incentive = factor(incentive, labels=c("No Incentive", "Incentive"))) %>%
  group_by(incentive) %>%
  sample_n(20)

ggplot(student.class.data, aes(x=cumulative.canvas.grade, y=delta.z, color=incentive))+
  facet_wrap(.~class.id)+
  scale_color_brewer(type="qual",palette = "Set1", name="Incentive Condition")+
  geom_point(alpha=0.2)+
  theme_bw()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```


