---
title: "ManyClasses 1 Simulated Analysis"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(runjags)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggridges)
library(stringr)
library(tibble)
library(forcats)
```

# Generating Fake Data

To simulate the analysis, we generate data that has the same structure as the eventual ManyClasses 1 data. These are the parameters of that data generating process.

```{r}
n.classes <- 40
```

Generate a data frame of classes with random values for each factor.

```{r}
classes <- data.frame(
  class.id=1:n.classes,
  incentive=sample(c("Incentive", "NoIncentive"), n.classes, replace=T),
  discipline=sample(c("STEM", "Non-STEM"), n.classes, replace=T),
  format=sample(c("Classroom", "Online", "Hybrid"), n.classes, replace=T),
  class.size=rbinom(n.classes, 150, 0.5),
  proportion.lecture=rbeta(n.classes, 0.8, 0.8),
  n.assignments=2+rbinom(n.classes, 10, 0.1),
  class.level=sample(c("Intro","Intermediate","Advanced"), n.classes, replace=T),
  n.exams=2+sample(c(0,2),n.classes, prob = c(0.8, 0.2), replace=T),
  admission.rate=rbeta(n.classes,5,2)
)
```


Then we generate students that come from each class, create exams, assign random scores to the exams, and normalize the data. To norm the data we z-score each exam separately, and then find the average difference in z-scores for delayed and immediate feedback.

```{r}
student.data <- NA
for(c in 1:n.classes){
  class.size <- classes$class.size[c]
  student.id <- 1:class.size
  exam <- 1:(classes$n.exams[c])
  one.class <- expand.grid(student.id=student.id, exam=exam) %>% 
    mutate(immediate.feedback = if_else(student.id <= class.size/2, exam %% 2 == 1, exam %% 2 == 0)) %>% 
    mutate(feedback = if_else(immediate.feedback, "Immediate", "Delayed")) %>% 
    select(-immediate.feedback) %>%
    mutate(exam.score = rnorm(n(),0,1)) %>%
    group_by(exam) %>%
    mutate(m = mean(exam.score), sd = sd(exam.score), exam.score.normed = (exam.score - mean(exam.score)) / sd(exam.score)) %>%
    ungroup() %>%
    group_by(student.id, feedback) %>%
    summarize(average.z = mean(exam.score.normed)) %>%
    spread(feedback, average.z) %>%
    mutate(delta.z = Immediate - Delayed) %>%
    mutate(class.id = c)
  if(c > 1){
    student.data <- rbind(student.data, one.class)
  } else {
    student.data <- one.class
  }
}
```

Generating moderator variables for students

```{r}
student.data <- student.data %>% mutate(
  access.assignment = sample(c("No", "Yes"), n(), replace=T, prob=c(0.1, 0.9)),
  time.spent.on.assignment = rgamma(n(), 10)
)
```

# Preparing Data for Model

The data needs to be reformatted for the JAGS model.

```{r}
# convert to numeric factors
classes$incentive <- as.numeric(factor(classes$incentive, levels=c("NoIncentive", "Incentive")))
classes$discipline <- as.numeric(factor(classes$discipline, levels=c("STEM", "Non-STEM")))
classes$format <- as.numeric(factor(classes$format, levels=c("Classroom", "Online", "Hybrid")))
classes$class.level <- as.numeric(factor(classes$class.level, levels=c("Intro", "Intermediate", "Advanced")))

# list of moderators to allow dynamic construction
metric.moderators <- c('class.size', 'proportion.lecture', 'n.assignments', 'n.exams', 'admission.rate')
nominal.moderators <- c('discipline','format','class.level')

# summaries for JAGS
delta.z <- student.data$delta.z
n.students <- nrow(student.data)
class.index <- student.data$class.id
class.condition <- classes$incentive
n.metric.moderators <- 5
n.nominal.moderators <- 3
n.levels.nominal.moderator <- c(2,3,3)
n.conditions <- 2
y.metric <- array(data=t(as.matrix(classes)[,metric.moderators]), dim=c(n.metric.moderators, n.classes))
y.nominal <- array(data=t(as.matrix(classes)[,nominal.moderators]), dim=c(n.nominal.moderators, n.classes))

# packaging data for JAGS
jags.data <- list(
  delta.z=delta.z,
  n.students=n.students,
  class.index=class.index,
  class.condition=class.condition,
  n.metric.moderators=n.metric.moderators,
  n.nominal.moderators=n.nominal.moderators,
  n.conditions=n.conditions,
  n.classes=n.classes,
  n.levels.nominal.moderator=n.levels.nominal.moderator,
  y.metric=y.metric,
  y.nominal=y.nominal
)
```

# Model 1: Overall Effect of Feedback and Incentives

```{r}
# set some runjags options
runjags.options(force.summary=TRUE, silent.jags=TRUE, silent.runjags=TRUE)
```

## Running the Model

```{r}
model.1.result <- run.jags(
  model='basic-model-jags.txt', 
  data=jags.data,
  n.chains = 3,
  sample = 1000,
  burnin = 1000,
  monitor = c('mu.class','sigma.class', 'mu.condition.effect', 'sigma.condition.effect', 'sigma.mode', 'sigma.sd')
)
```

## Class-level effects

Start with merging the model results with the class-level data, and adding columns to differentiate parameters of the model.

```{r message=FALSE, warning=FALSE}
model.1.summary <- as.data.frame(model.1.result$summaries)
model.1.summary <- model.1.summary %>%
  rownames_to_column() %>%
  remove_rownames() %>%
  mutate(parameter = str_remove(rowname, "\\[.*\\]")) %>%
  mutate(class.id = as.numeric(if_else(parameter %in% c("mu.class", "sigma.class"), str_extract(rowname, "[0-9]+"), "NA"))) %>%
  mutate(i.condition = as.numeric(if_else(parameter %in% c("mu.condition.effect", "sigma.condition.effect"), str_extract(rowname, "[0-9]+"), "NA"))) %>%
  left_join(classes) %>%
  mutate(i.merge = if_else(!is.na(i.condition), i.condition, incentive)) %>%
  mutate(incentive = factor(i.merge, labels = c("Incentive","No Incentive"))) %>%
  select(-i.merge, -i.condition)
```

```{r fig.height=7, fig.width=7}
model.1.summary %>% 
  filter(parameter %in% c("mu.class", "mu.condition.effect")) %>% 
  mutate(y.label = factor(if_else(is.na(class.id), as.character(incentive), as.character(class.id)))) %>%
  mutate(y.label = fct_reorder(y.label, Mean)) %>%
ggplot(aes(x=Mean, xmin=Lower95, xmax=Upper95, y=y.label, color=incentive))+
  geom_errorbarh()+
  geom_point()+
  geom_vline(xintercept=0, linetype='dashed') +
  labs(y="Class ID", x="Relative Benefit of Immediate Feedback")+
  facet_grid(parameter~., scales = 'free', space='free')+
  scale_color_brewer(name="Incentive Condition", type="qual", palette = "Set1")+
  theme_minimal()+
  theme(strip.background = element_blank(), strip.text = element_blank())
```
